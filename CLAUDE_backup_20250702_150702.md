# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Whaticket is a multi-tenant WhatsApp ticketing system built with Node.js/TypeScript backend and React frontend. It enables companies to manage WhatsApp conversations through a ticket-based system with features like campaigns, chatbots, queues, and multi-company support.

## Node.js Version Requirements

**Critical**: This project requires specific Node.js versions due to compatibility constraints:
- **Backend**: Node.js v18.x+ (required for whatsapp-web.js library compatibility)
- **Frontend**: Node.js v16.x+ (updated from v14.21.3 after dependency migration)

Always verify and switch Node.js versions before development:
```bash
# For backend work
nvm use 18

# For frontend work  
nvm use 16
```

## Development Commands

### Backend Setup & Development
```bash
cd backend

# Install dependencies
npm install

# Database setup (first time only)
npx sequelize db:create
npx sequelize db:migrate
npx sequelize db:seed:all

# Development
npm run dev:server          # Development server with hot reload
npm run build              # Compile TypeScript
npm start                  # Production server
npm run lint               # Lint code
npm test                   # Run tests

# Database operations
npm run db:migrate         # Run new migrations
npm run db:seed           # Run seeders
```

### Frontend Setup & Development
```bash
cd frontend

# Install dependencies (use legacy peer deps for compatibility)
npm install --legacy-peer-deps

# Development
npm start                  # Development server (port 3000)
npm run build             # Production build
npm test                  # Run tests
```

## Architecture Overview

### Backend Architecture
- **Express.js** server with TypeScript
- **Sequelize ORM** with PostgreSQL database
- **Socket.IO** for real-time communication
- **Bull Queue** for background job processing
- **whatsapp-web.js** library for WhatsApp Web integration (migrated from Baileys)
- **Multi-tenant** architecture with company-based isolation

Key directories:
- `src/controllers/` - HTTP request handlers
- `src/services/` - Business logic layer
- `src/models/` - Sequelize database models
- `src/routes/` - API route definitions
- `src/libs/` - Core libraries (socket, cache, wbot)
- `src/queues.ts` - Background job processing (935 lines, complex)
- `src/database/migrations/` - Database schema changes

### Frontend Architecture
- **React 17** with Material-UI v4
- **React Query** for API state management
- **Socket.IO Client** for real-time updates
- **React Router v5** for navigation
- **Dark/Light theme** system with persistent preferences

Key directories:
- `src/components/` - Reusable React components
- `src/pages/` - Page-level components
- `src/services/` - API communication layer
- `src/context/` - React context providers
- `src/layout/` - Layout components and theme

### WhatsApp Integration Flow
1. **Connection**: whatsapp-web.js library connects to WhatsApp Web via QR code with LocalAuth
2. **Message Processing**: Incoming WhatsApp messages are converted to tickets
3. **Queue System**: Messages are processed through configurable queues
4. **Agent Assignment**: Tickets are assigned to agents based on queue rules
5. **Real-time Updates**: Socket.IO broadcasts updates to connected clients
6. **Response Handling**: Agent responses are sent back to WhatsApp contacts

### Multi-Tenancy
- Each company has isolated data (contacts, tickets, users, settings)
- Company ID is propagated through all database operations
- Separate WhatsApp connections per company
- Company-specific configurations and plans

## Database & Configuration

### Environment Files
- Backend: `.env` (DATABASE_URL, JWT secrets, Redis config)
- Frontend: `.env` (REACT_APP_BACKEND_URL)

### Database Setup
- **PostgreSQL** as primary database
- **Redis** for sessions and queue management
- Extensive migration system (80+ migrations)
- Multi-company data isolation via `companyId` foreign keys

### Critical Configuration
- CORS setup between frontend (port 3000) and backend (port 8080)
- JWT authentication with refresh tokens
- Redis configuration for Bull queues
- File upload handling for media messages

## Migration from Baileys to whatsapp-web.js

**Migration Status: COMPLETED ✅**

This project has been successfully migrated from Baileys to whatsapp-web.js for improved stability and better WhatsApp Web integration.

### Migration Summary

**Phase 1: Preparation ✅**
- Removed Baileys dependencies (`@whiskeysockets/baileys`, `@adiwajshing/keyed-db`)
- Installed whatsapp-web.js v1.23.0 and dependencies
- Fixed security vulnerabilities (hardcoded passwords, JWT secrets)
- Added environment validation (`validateEnv.ts`)

**Phase 2: Core Components ✅**
- Completely rewritten `src/libs/wbot.ts` for whatsapp-web.js
- Removed `src/helpers/authState.ts` (handled automatically by LocalAuth)
- Created `src/libs/wwebjs-types.ts` for TypeScript compatibility
- Migrated all helper functions (GetTicketWbot, GetWbotMessage, etc.)

**Phase 3: Messaging Services ✅**
- Migrated `SendWhatsAppMessage.ts` → `chat.sendMessage()`
- Migrated `SendWhatsAppMedia.ts` → `MessageMedia.fromFilePath()`
- Migrated `SendWhatsAppReaction.ts` → `message.react()`
- Migrated `EditWhatsAppMessage.ts` → `message.edit()`
- Migrated auxiliary services (CheckNumber, GetProfilePicUrl, etc.)

**Phase 4: Message Processing ✅**
- Completely migrated `wbotMessageListener.ts` (1600+ lines)
- Updated `wbotMonitor.ts` and `StartWhatsAppSession.ts`
- Removed obsolete Baileys services

### Key Changes

**API Differences:**
```typescript
// OLD (Baileys)
await wbot.sendMessage(jid, { text: body });
const media = await downloadMediaMessage(msg);

// NEW (whatsapp-web.js)
const chat = await wbot.getChatById(chatId);
await chat.sendMessage(body);
const media = await message.downloadMedia();
```

**Contact ID Format:**
- Baileys: `${number}@s.whatsapp.net`
- whatsapp-web.js: `${number}@c.us` (contacts), `${number}@g.us` (groups)

**Authentication:**
- Baileys: Custom `authState.ts` with manual session management
- whatsapp-web.js: `LocalAuth` with automatic session persistence in `.wwebjs_auth/`

**Events:**
```typescript
// OLD (Baileys)
socket.ev.on('messages.upsert', handler);

// NEW (whatsapp-web.js)
client.on('message', handler);
client.on('message_create', handler);
```

### Benefits of Migration

1. **Better Stability**: whatsapp-web.js is more stable with fewer breaking changes
2. **Improved Documentation**: Better community support and documentation
3. **Modern APIs**: More intuitive and feature-complete API
4. **Better Media Handling**: Simplified multimedia processing
5. **Automatic Session Management**: No manual auth state handling required

### Files Modified/Created

**Core Files:**
- `src/libs/wbot.ts` - Complete rewrite
- `src/libs/wwebjs-types.ts` - New type definitions
- `src/config/validateEnv.ts` - New environment validation

**Services Migrated:**
- All files in `src/services/WbotServices/` (18+ files)
- `src/helpers/` - GetTicketWbot, GetWbotMessage, SetTicketMessagesAsRead

**Files Removed:**
- `src/helpers/authState.ts`
- `src/services/BaileysServices/` (entire directory)
- `src/services/BaileysChatServices/` (entire directory)

## Security Considerations

**Migration Security Improvements ✅:**
- ✅ Fixed hardcoded database password in `src/config/database.ts:14`
- ✅ Added mandatory environment variable validation
- ✅ Enforced strong JWT secrets

**Remaining Issues to Address:**
- SQL injection vulnerability in `src/queues.ts` (lines 816, 823)
- TypeScript strict mode disabled (`tsconfig.json`)

## Development Workflow

### Making Changes
1. Always check Node.js version before starting
2. Backend changes require TypeScript compilation (`npm run build`)
3. Database changes need migrations (`npx sequelize migration:generate`)
4. Test both real-time (Socket.IO) and API functionality
5. Verify multi-company isolation in changes

### Testing WhatsApp Integration
- QR code authentication required for each WhatsApp connection
- Test message sending/receiving flow
- Verify queue processing and agent assignment
- Check real-time updates in frontend

### Common Gotchas
- Frontend requires `--legacy-peer-deps` for installation
- Mixed Material-UI versions (v4 and v5) in frontend
- Large `queues.ts` file handles multiple responsibilities
- Duplicate messageRoutes in route configuration
- Case-sensitive file imports in TypeScript

## Deployment Notes

- Backend uses custom startup script (`start-backend.js`) to handle Node.js v16 compatibility
- Frontend builds to static files for serving
- Requires PostgreSQL and Redis services
- WhatsApp connections need persistent sessions
- File uploads stored in `backend/public/` directory

## Integration Points

- **N8N Integration**: Webhook support for external automations
- **Typebot Integration**: Chatbot functionality
- **Campaign System**: Bulk messaging capabilities
- **AI Integration**: OpenAI integration for automated responses
- **Subscription Management**: Plan-based feature limitations

---

## Research Query

Investigate the "WhatsApp API" component in detail. Provide a comprehensive analysis of its architecture, responsibilities, and implementation details.

*Session: eff6834f09ebd7f06c3f72be8d3d3334 | Generated: 2/7/2025, 11:56:40*

### Analysis Summary

# WhatsApp API Component Analysis

This report details the architecture, responsibilities, and implementation of the WhatsApp API component within the codebase. The component is primarily managed by the `WhatsAppController`, `WhatsappService` (a collection of services), and `WbotServices` (a directory of services that directly interact with the WhatsApp Web API).

## High-Level Architecture

The WhatsApp API component is structured in a layered architecture to manage WhatsApp interactions efficiently.

*   **API Layer (backend/src/controllers/WhatsAppController.ts):** This is the external interface, handling HTTP requests related to WhatsApp accounts. It acts as the entry point for all WhatsApp-related operations from the frontend.
*   **Business Logic/Data Access Layer (backend/src/services/WhatsappService/):** This layer encapsulates the core business logic for managing WhatsApp account data, including persistence and retrieval from the database.
*   **WhatsApp Bot Interaction Layer (backend/src/services/WbotServices/):** This layer directly interacts with the WhatsApp Web API (likely via the `whatsapp-web.js` library), abstracting the complexities of session management, message sending, and message receiving.

## Mid-Level Interactions and Session Management

The three main components collaborate to manage WhatsApp sessions and message flows.

### WhatsAppController (file:backend/src/controllers/WhatsAppController.ts)

The **WhatsAppController** (node:WhatsAppController_WC1) is responsible for handling API requests and orchestrating the creation, management, and deletion of WhatsApp sessions.

*   **Purpose:** Acts as the **API endpoint handler** for all WhatsApp-related operations. It receives HTTP requests, delegates business logic to appropriate services, and sends back HTTP responses.
*   **Key Functionalities:**
    *   **`index` (List):** Retrieves a list of WhatsApp accounts associated with a company. (file:backend/src/controllers/WhatsAppController.ts:39)
    *   **`store` (Create):** Creates a new WhatsApp account, including its name, associated queues, greeting messages, and other configurations. It initiates a WhatsApp session for the newly created account by calling `CreateWhatsAppService` and `StartWhatsAppSession`. (file:backend/src/controllers/WhatsAppController.ts:47)
    *   **`show` (Retrieve):** Fetches details of a specific WhatsApp account by its ID. (file:backend/src/controllers/WhatsAppController.ts:108)
    *   **`update`:** Modifies the details of an existing WhatsApp account. (file:backend/src/controllers/WhatsAppController.ts:118)
    *   **`remove` (Delete):** Deletes a WhatsApp account and removes its associated WhatsApp bot session by calling `DeleteWhatsAppService` and `removeWbot`. (file:backend/src/controllers/WhatsAppController.ts:148)
    *   **`restart`:** Allows an administrator to restart the WhatsApp bot for a given company by calling `restartWbot`. (file:backend/src/controllers/WhatsAppController.ts:170)
    *   **Real-time Updates:** Uses `socket.io` (`getIO()`) to emit real-time updates to connected clients when WhatsApp accounts are created, updated, or deleted, ensuring the frontend is always synchronized. (file:backend/src/controllers/WhatsAppController.ts:92, file:backend/src/controllers/WhatsAppController.ts:132, file:backend/src/controllers/WhatsAppController.ts:160)
*